!function(t){"use strict";function i(t){this.container=t,this.buttonDom=this.container.find(".select-button"),this.fileDom=this.container.find("input[type=file]"),this.tokenUrl=this.container.data("url"),this.checkTranscodeUrl=this.container.data("checktranscode"),this.loadingUrl=this.container.data("loading"),this.field=this.container.data("field"),this.table=this.container.find(".table"),this.boardContainer=this.container.find(".fsUploadProgress"),this.boards=[],this.multiple=null,this.option=null}function n(t,i,n,e,s,o,a){this.qiniuav=t,this.id=i,this.file_id=s,this.filename=n,this.filesize=e,this.file_url=o,this.observable=null,this.subscription=null,this.chunkNum=Math.ceil(e/4194304),this.ui="<td><input type='hidden' class='field-hidden' name='' /><span class='filename'>"+n+"</span><div class='wraper'><a class='linkWrapper'></a></div></td><td class='size'>"+e+"</td><td><div style='overflow:hidden;position:relative' class='detail-container'><div class='totalBar' style='float:left;width:80%;height:30px;border:1px solid;border-radius:3px'><div class='totalBarColor' style='width:0;border:0;background-color:rgba(232,152,39,0.8);height:28px;'></div><p class='speed'></p></div><div class='control-container'><button class=\"btn btn-default control-upload\" type=\"button\">开始上传</button></div></div><div><button class='btn btn-default resume' type=\"button\">查看分块进度</button></div><ul class='fragment-group hide'></ul></td><td class='opration-container'><button class=\"btn btn-danger delete confirm\" style='margin-left: 5px;' type=\"button\">删除</button></td>",this.dom=null,this.resumeBtn=null,this.controlBtn=null,this.controlStat="",this.totalBarText=null,this.totalBar=null,this.totalBarContainer=null,this.detailContainer=null,this.deleteBtn=null,this.oprationContainer=null,this.fileInput=null,this.checkTranscode=null,this.sizeDom=null,this.filenameDom=null,this.chunkList=[],this.chunkListDom=null,this.finishedChunkList=[],this.init(a)}function e(){this.ui="<div class='childBar' style='width:100%;height:20px;border:1px solid;border-radius:3px'><div class='childBarColor' style='width:0;border:0;background-color:rgba(250,59,127,0.8);height:18px;'></div></div>",this.dom=null,this.percent=0,this.init()}t.fn.qiniuav=function(n){t(this).each(function(){new i(t(this)).init(n)})},i.prototype.init=function(t){this.option=t,this.multiple=void 0!==this.container.attr("multiple");var i=this;this.buttonDom.on("click",this.container,function(){i.fileDom.trigger("click")});for(var n=0;n<this.option.files.length;n++){this.table.show();var e=this.createBoard(this.option.files[n]);this.boards.push(e),this.boardContainer.append(e.dom)}this.fileDom.on("change",this.container,function(){var t=this.files[0];fetch(i.tokenUrl).then(function(t){if(t.ok)return t.json();throw"something go error, status:".res.status}).then(function(n){var e=n.token,s={key:"",fname:"",params:{"x:type":n.type}},o=t.name.substr(t.name.lastIndexOf(".")+1);if(s.key=n.key+(o?"."+o:""),t){i.table.show(),i.multiple||i.deleteBoard();var a=i.createUploadBoard(t,s,e,{});i.boards.push(a),i.boardContainer.append(a.dom)}})})},i.prototype.createUploadBoard=function(t,i,e,s){var o=new n(this,this.boards.length,t.name,t.size,0,"","upload");return o.observable=qiniu.upload(t,i.key,e,i,s),o},i.prototype.createBoard=function(t){return 1==t.transcode?new n(this,this.boards.length,t.name,t.size,t.id,t.url,"view"):new n(this,this.boards.length,t.name,t.size,t.id,"","transcode")},i.prototype.deleteBoard=function(t){if(void 0===t){for(var i=0;i<this.boards.length;i++)void 0!==this.boards[i]&&this.boards[i].destroy();this.boards=[],this.fileDom.val("")}else this.boards[t].destroy(),delete this.boards[t],0==this.boardContainer.children().length&&this.table.hide()},n.prototype.init=function(i){this.dom=t(document.createElement("tr")),this.dom.html(this.ui),this.resumeBtn=this.dom.find(".resume"),this.controlBtn=this.dom.find(".control-upload"),this.controlStat="ready",this.chunkListDom=this.dom.find(".fragment-group"),this.totalBarText=this.dom.find(".speed"),this.totalBar=this.dom.find(".totalBarColor"),this.totalBarContainer=this.dom.find(".totalBar"),this.detailContainer=this.dom.find(".detail-container"),this.deleteBtn=this.dom.find(".delete"),this.fileInput=this.dom.find(".field-hidden"),this.oprationContainer=this.dom.find(".opration-container"),this.sizeDom=this.dom.find(".size"),this.filenameDom=this.dom.find(".filename"),this.qiniuav.multiple?this.fileInput.attr("name",this.qiniuav.field+"[]"):this.fileInput.attr("name",this.qiniuav.field);var n=this;switch(i){case"upload":if(this.chunkNum>1)for(var e=0;e<this.chunkNum;e++)this.createChunk();else this.resumeBtn.addClass("hide");this.resumeBtn.on("click",this.dom,function(){n.chunkListDom.hasClass("hide")?n.chunkListDom.removeClass("hide"):n.chunkListDom.addClass("hide")}),this.controlBtn.on("click",this.dom,function(){switch(n.controlStat){case"ready":n.upload();break;case"uploading":n.pause()}});break;case"transcode":this.resumeBtn.addClass("hide"),this.fileInput.val(this.file_id),this.transcoding();break;case"view":this.resumeBtn.addClass("hide"),this.fileInput.val(this.file_id),this.finishTranscode(this.file_url,this.filesize);break;default:throw"unknow type value:"+i}this.deleteBtn.on("click",this.dom,function(){n.qiniuav.deleteBoard(n.id)})},n.prototype.initCbConfig=function(){var t=this;return{next:function(i){var n=i.chunks||[],e=i.total;t.refresh(e.percent,n)},error:function(i){t.setError(i.message)},complete:function(i){t.fileInput.val(i.file_id),t.file_id=i.file_id,i.ref_id?t.transcoding():t.setComplete(i.info)}}},n.prototype.transcoding=function(){var t="<span>转码中</span><img src='"+this.qiniuav.loadingUrl+"' style='width: 35px;position: absolute;top: -7px;' />";this.detailContainer.html(t);var i=this;this.checkTranscode=setInterval(function(){fetch(i.qiniuav.checkTranscodeUrl+"?file_id="+i.file_id).then(function(t){if(t.ok)return t.json();throw"something go error, status:".res.status}).then(function(t){1==t.status?(window.clearInterval(i.checkTranscode),i.finishTranscode(t.url,t.size,t.name)):2==t.status&&(window.clearInterval(i.checkTranscode),i.errorTranscode(t.error))})},2e3)},n.prototype.errorTranscode=function(t){this.detailContainer.html("<p>"+t+"</p>")},n.prototype.finishTranscode=function(t,i,n){if(this.detailContainer.html("<p>"+t+"</p>"),this.sizeDom.text(i),this.filenameDom.text(n),this.qiniuav.option.play.name){this.oprationContainer.prepend("<button type='button' class=\"btn btn-success play\">"+this.qiniuav.option.play.name+"</button>");var e=this;this.oprationContainer.find(".play").on("click",this.oprationContainer,function(){e.qiniuav.option.play.action(t)})}},n.prototype.upload=function(){this.setUploading(),this.subscription=this.observable.subscribe(this.initCbConfig())},n.prototype.pause=function(){this.setReady(),this.subscription.unsubscribe()},n.prototype.setError=function(t){this.controlStat="error",this.detailContainer.text(t)},n.prototype.setUploading=function(){this.controlStat="uploading",this.controlBtn.text("暂停上传")},n.prototype.setReady=function(){this.controlStat="ready",this.controlBtn.text("继续上传")},n.prototype.setComplete=function(t){this.controlStat="complete",this.totalBarContainer.addClass("hide"),this.detailContainer.html(t)},n.prototype.destroy=function(){this.dom.remove(),this.subscription&&(this.subscription.unsubscribe(),this.subscription=null),this.observable=null,this.resumeBtn=null,this.controlBtn=null,this.controlStat="",this.totalBarText=null,this.totalBar=null,this.totalBarContainer=null,this.detailContainer=null,this.deleteBtn=null,this.fileInput=null,this.oprationContainer=null,this.sizeDom=null,this.chunkList=[],this.chunkListDom=null,this.finishedChunkList=[],this.dom=null},n.prototype.refresh=function(t,i){for(var n=0;n<i.length;n++)0===i[n].percent||this.finishedChunkList[n]||this.chunkList[n].percent!==i[n].percent&&(100===i[n].percent&&(this.finishedChunkList[n]=!0),this.chunkList[n].refresh(i[n].percent));this.totalBarText.text("进度："+t+"% "),this.totalBar.css("width",t+"%")},n.prototype.createChunk=function(){var t=new e;this.chunkList.push(t),this.chunkListDom.append(t.dom)},e.prototype.init=function(){this.dom=document.createElement("li"),this.dom=t(this.dom),this.dom.addClass("fragment"),this.dom.html(this.ui)},e.prototype.refresh=function(t){this.percent=t,this.dom.find(".childBarColor").css("width",t+"%")}}(jQuery);